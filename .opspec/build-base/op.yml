name: build-base
description: builds iam base nodejs app

inputs:
  HOME:
    dir:  
      description: path to home dir
      
  appDir:
    dir:
      default: ./

  version:
    string:
      description: version to use for iam
  
  push:
    string:
      default: "false"

  dockerSocket:
    socket:
      description: docker socket to use for building
run:
  serial:
  - container:
      image: 
        ref: node:11.15
      dirs:
        /src: $(appDir)
      workDir: /src/apps/base
      cmd: [bash, build.sh]
  
  - op:
      ref: ../docker-build
      inputs:
        HOME:
        dockerSocket:
        push:
        imageRef: icanplayguitar94/iam:base-$(version)
        src: $(appDir/images/base)
  
  - container:
      image:
        ref: ubuntu:18.04
      dirs:
        /src: $(appDir)
      envVars:
        TAG: "icanplayguitar94/iam:base-$(version)"
      workDir: /src
      cmd: 
      - bash
      - -c
      - | 

        # Image Templates
        bash images/templates/client.sh $TAG
        bash images/templates/builder.sh $TAG
        bash images/templates/job.sh $TAG
        bash images/templates/secret.sh $TAG
        